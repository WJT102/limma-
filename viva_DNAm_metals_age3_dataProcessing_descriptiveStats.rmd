---
title: "Project Viva: age 3 blood DNAm data processing and descriptive stats"
output:
  html_document:
    toc: true
    toc_float: true
---


## Required Packages and functions

```{r,warning=FALSE,message=FALSE,eval=FALSE}

library(sas7bdat)
library(sva)
library(reshape)
library(ggplot2)
library(gridExtra)
library(knitr)
library(dplyr)
library(kableExtra)
library(tidyverse)
library(minfi)
library(stringr)
library(limma)
library(IlluminaHumanMethylation450kanno.ilmn12.hg19)
library(UpSetR)
library(reshape)
library(corrplot)
library(factoextra)

anno = getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)
anno = data.frame(anno)
```


## DNAm and pheno data

```{r,warning=FALSE,message=FALSE,eval= FALSE}

# Load datasets
pheno = read.sas7bdat('/Users/annebozack/Box/NIEHS-R01 ONES/Phenotype Data/anne_bozack_ac_120720.sas7bdat')

load("/Users/annebozack/Box/DNA Methylation Data/ProjectVivaMethylationBetas_forCPrice_2020-06-10.RData")

objects()

dim(pheno)
# 2128   90

dim(betas)
# 470870   1127

dim(fDat)
# 470870      3

dim(pDat)
# 1127   20

# Filter Repeats and low QA
pDat2 <- pDat[pDat$lowQual==T & pDat$filter.gender==T & pDat$filter.geno==T & pDat$repUse==T,]
dim(pDat2)
# 1065   20

# Dimentions [False for rows/True for columns (People/Flags)]
dim(pDat2)==dim(pDat)
# FALSE  TRUE

# Restrict to age 7 blood 0nly
pDatAge3 <- pDat2[pDat2$COLLECTION=="Proband Age 3",]
dim(pDatAge3)
# 120  20    # 120 samples 

# Add pheno data
colnames(pheno)[1] = 'alias'

pDatAge3 = merge(pDatAge3, pheno, by = 'alias', all.x = T, all.y = F)

# Subset the methylation data
pDatAge3$samplename[1:5]
colnames(betas)[1:5]

betasAge3 <- betas[,colnames(betas) %in% pDatAge3$samplename]
dim(betasAge3)
# 470870    120

pDatAge3 <- pDatAge3[match(colnames(betasAge3), pDatAge3$samplename),]

identical(pDatAge3$samplename, colnames(betasAge3))
# TRUE

# Sort to ensure match
betasAge3 <- betasAge3[,match(pDatAge3$samplename, colnames(betasAge3))]

identical(pDatAge3$samplename, colnames(betasAge3))
# TRUE

all(pDatAge3$samplename==colnames(betasAge3))
# TRUE

## RowNames
rownames(pDatAge3)= pDatAge3$samplename
all(rownames(pDatAge3)==colnames(betasAge3))
# TRUE

# Filter Out bad probes
## Subset fDat to only probes you want - try with 95% cutoff
fDatselect <- fDat[fDat$perc.detected > 95,]
dim(fDatselect)
# 467471      3

# subset betasAge3 to fDatselect probes
betasAge3use <- betasAge3[rownames(betasAge3) %in% fDatselect$site,]
dim(betasAge3) 
# 470870   120

# match fDat and betasAge3 based on CpG
fDatselect<- fDatselect[match(fDatselect$site, rownames(betasAge3use)),]

identical(fDatselect$site, rownames(betasAge3use))
# TRUE

all(fDatselect$site==rownames(betasAge3use))
# TRUE

dim(fDatselect)
# 467471      3

dim(betasAge3use)
# 467471    120

# check once again
all(pDatAge3$samplename==colnames(betasAge3use))
# TRUE

# ComBat Adjust by Sample Plate
# logit transform to M-vals
range(betasAge3use)
# 0.0017699 0.9997292

dim(betasAge3use)
# 467471    120

Mvalues= log2(betasAge3use)-log2(1-betasAge3use)
dim(Mvalues)
# 467471    120

# Match?
all(pDatAge3$samplename==colnames(Mvalues))
# TRUE

identical(pDatAge3$samplename,colnames(Mvalues))
# TRUE

# Batch
table(pDatAge3$Batch)
# WG0006663-BCD0 WG0006664-BCD0 WG0006665-BCD0 WG0006666-BCD0 WG0006667-BCD0 WG0006668-BCD0 WG0006669-BCD0 WG0006669-BCD1 WG0006670-BCD1 WG0006671-BCD0 WG0006671-BCD1 WG0006672-BCD0 
            # 12              8             12             11             12              9              3              4              5              0              1              3 
# WG0006672-BCD1 WG0006673-BCD0 WG0006673-BCD1 WG0006674-BCD0 WG0006674-BCD1 WG0006676-BCD0 WG0006677-BCD0 WG0006678-BCD0 
             # 1              0              5              3              1             17              9              4 

# Plate
table(pDatAge3$Sample.Plate)
# WG0006663-BCD WG0006664-BCD WG0006665-BCD WG0006666-BCD WG0006667-BCD WG0006668-BCD WG0006669-BCD WG0006670-BCD WG0006671-BCD WG0006672-BCD WG0006673-BCD WG0006674-BCD WG0006676-BCD 
           # 12             8            12            11            12             9             7             5             1             4             5             4            17 
# WG0006677-BCD WG0006678-BCD 
            # 9             4 

# Remove unwanted data
rm(pDat,fDat,fDatselect,betas,betasAge3,betasAge3use,pDat2);gc()


# Filter probes
anno$NONCPG <- 1*(substring(rownames(anno),1,2)=="ch") 
table(anno$NONCPG)  
# 3,091  ch/rs probes

anno$SNP <- 1*(substring(rownames(anno),1,2)=="rs") # 0 rs probes
table(anno$SNP) 
# 0 actual SNP Data

# Removing SNP associated probes with MAF>5%
sum((anno$Probe_maf>=0.05),na.rm=T) 
# 44683

anno$Probe_r_exclude <- rep(0,dim(anno)[1])
anno$Probe_r_exclude[anno$Probe_maf>=0.05] <-1

table(anno$Probe_r_exclude)                    
# 44,683  to exclude

anno = anno[anno$Probe_r_exclude==0,]  # select MAF<5%
dim(anno) 
# 440829     36

# SNPs at Single-Base Extension (SBE) removing if MAF>=5%
anno$SNPatSBE <- rep(0,dim(anno)[1])
sum((anno$SBE_maf>=0.05),na.rm=T)            
# 3,398 SNPs at SBE

anno$SNPatSBE[anno$SBE_maf>=0.05] <-1
table(anno$SNPatSBE)     
# 3,398 to exclude

anno = anno[anno$SNPatSBE==0,] # Select non polymorphic SBE >5%
dim(anno) 
# 437431	37

# SNPs at the actual CpG with MAF>0.05  removing MAF>=5%

anno$SNPatCPG <- rep(0,dim(anno)[1])
sum((anno$CpG_maf>=0.05),na.rm=T)            
# 4,056 CpGs on SNPS at MAF>5%

anno$SNPatCPG[anno$CpG_maf>=0.05] <-1
table(anno$SNPatCPG) 
# 4,056

anno = anno[anno$SNPatCPG==0,]
rownames(anno)=anno$TargetID
dim(anno) 
# 433375	38

# Remove probes with SNPs within 10 bps of the target site

# Remove Chen Probes
Chen<-read.csv('/Users/annebozack/Box/NIEHS-R01 ONES/Methylation Data/NonSpecProbes.csv')
dim(Chen)[1] 
# 29,233 CpGs

length(intersect(Chen$TargetID, anno$Name))
# 23,550 overlap after cleaning

# 450K minus Chen probes
anno.Chen<-anno[!anno$Name %in% Chen$TargetID,]
dim(anno.Chen) 
# 409825	38

table(rownames(Mvalues) %in% anno.Chen$Name)
# FALSE   TRUE 
# 73011 394460 
 
# drop probes not in anno.Chen dataset
Mvalues = Mvalues[rownames(Mvalues) %in% anno.Chen$Name,]

dim(Mvalues)
# 394460    120


# run ComBat for plate
ComBat.Mvalues <- ComBat(dat=Mvalues, batch=pDatAge3$Sample.Plate)

# convert this back to a beta scale:
combat.beta <- (2^ComBat.Mvalues)/(2^ComBat.Mvalues + 1)

range(combat.beta) 
# 0.0006885065 0.9994490831

dim(combat.beta)
# 394460    120

# Match?
all(pDatAge3$samplename==colnames(combat.beta))
# TRUE

identical(pDatAge3$samplename,colnames(combat.beta))
# TRUE

save(ComBat.Mvalues, combat.beta, pDatAge3, file = "/Users/annebozack/Box/NIEHS-R01 ONES/Methylation Data/Age3Blood_ComBat_Betas_Mvlas_filteredPorbes.RData")
```


## Removing second child for diplicate family IDs

```{r,warning=FALSE,message=FALSE,eval= FALSE}

# no duplidate IDs
length(unique(pDatAge3$alias))
# 120

# two duplicate family IDs
length(unique(pDatAge3$FamilyId))
# 119

# remove second child for diplicate family IDs
pDatAge3$FamilyId[duplicated(pDatAge3$FamilyId)]
# "130015" 

pDatAge3[pDatAge3$FamilyId %in% pDatAge3$FamilyId[duplicated(pDatAge3$FamilyId)],]

pDatAge3$alias[pDatAge3$FamilyId %in% pDatAge3$FamilyId[duplicated(pDatAge3$FamilyId)] & pDatAge3$parity_d == 1]
# "122972"

pDatAge3 = pDatAge3[!(pDatAge3$alias %in% c("122972")),]

dim(pDatAge3)
# 119 109

ComBat.Mvalues = ComBat.Mvalues[,colnames(ComBat.Mvalues) %in% pDatAge3$samplename]
ComBat.Mvalues = ComBat.Mvalues[,match(pDatAge3$samplename, colnames(ComBat.Mvalues))]
dim(ComBat.Mvalues)
# 394460    119

all(pDatAge3$samplename==colnames(ComBat.Mvalues))
# TRUE 
identical(pDatAge3$samplename,colnames(ComBat.Mvalues))
# TRUE

combat.beta = combat.beta[,colnames(combat.beta) %in% pDatAge3$samplename]
combat.beta = combat.beta[,match(pDatAge3$samplename, colnames(combat.beta))]
dim(combat.beta)
# 394460    119

all(pDatAge3$samplename==colnames(combat.beta))
# TRUE 
identical(pDatAge3$samplename,colnames(combat.beta))
# TRUE
```

### Remove participants with missing metal data

```{r,warning=FALSE,message=FALSE,eval= FALSE, echo = F}

# removing participants with missing metal data
pDatAge3Metal = pDatAge3[!is.na(pDatAge3$Al),]
dim(pDatAge3Metal)
# 92 109

ComBat.Mvalues.Metals = ComBat.Mvalues[,colnames(ComBat.Mvalues) %in% pDatAge3Metal$samplename]
ComBat.Mvalues.Metals = ComBat.Mvalues.Metals[,match(pDatAge3Metal$samplename, colnames(ComBat.Mvalues.Metals))]
dim(ComBat.Mvalues.Metals)
# 394460    92

all(pDatAge3Metal$samplename==colnames(ComBat.Mvalues.Metals))
# TRUE 
identical(pDatAge3Metal$samplename,colnames(ComBat.Mvalues.Metals))
# TRUE

ComBat.Betas.Metals = combat.beta[,colnames(combat.beta) %in% pDatAge3Metal$samplename]
ComBat.Betas.Metals = ComBat.Betas.Metals[,match(pDatAge3Metal$samplename, colnames(ComBat.Betas.Metals))]
dim(ComBat.Betas.Metals)
# 394460    333

all(pDatAge3Metal$samplename==colnames(ComBat.Betas.Metals))
# TRUE 
identical(pDatAge3Metal$samplename,colnames(ComBat.Betas.Metals))
# TRUE

rm(combat.beta, ComBat.Mvalues);gc()

```


## Descriptive statistics

### Distribution of Beta-values

```{r,warning=FALSE,message=FALSE,eval= FALSE, echo = F}

beta.long = melt(ComBat.Betas.Metals)

ggplot(beta.long, aes(value, color=X2)) + geom_density() + theme_minimal() + theme(legend.position = "none") + scale_color_viridis_d(alpha=0.4)

quartz.save('/Users/annebozack/Documents/Cardenas/viva_DNAm_metals_local/age3DNAmDist.png', type = "png", dpi = 300)
```

```{r, out.width = '75%'}
knitr::include_graphics("/Users/annebozack/Documents/Cardenas/viva_DNAm_metals_local/age3DNAmDist.png")
```

### Participant characteristics

```{r,warning=FALSE,message=FALSE,eval= FALSE, echo = F}

# function to summarize continuous variables
tabMedian = function(df, vars){
	dfDescript = data.frame(matrix(ncol = 3, nrow = length(vars)))
	colnames(dfDescript) = c('Median', 'IQR', 'N missing')
	rownames(dfDescript) = vars
	for (i in 1:length(vars)){
		dfDescript[i,] = c(round(median(df[[vars[i]]], na.rm = T), 1), paste0(round(quantile(df[[vars[i]]], na.rm=T)[2], 1), ', ', round(quantile(df[[vars[i]]], na.rm = T)[4], 1)), sum(is.na(df[[vars[i]]])))
	}
	return(dfDescript)
}

tab1 = tabMedian(pDatAge3Metal, c('gestage_wks_deliv_d', 'age_mom_enroll_d', 'bmi_mom_prepreg_d', 'zvalue_bwt_gage_sex_d', 'b12_f1a', 'b12_wo_f1a', 'fol_wo_f1a', 'folate_f1a', 'alc_d_f1', 'fish_d_f1'))


# function to summarize categorical variables
tabFreq = function(df, vars){
	varCat = c()
	for (i in 1:length(vars)){
		cat = c()
		for (j in 1:length(levels(df[[vars[i]]]))){
			cat = c(cat, paste0(vars[i], '_', levels(df[[vars[i]]])[j]))
		}
		varCat = c(varCat, cat)
	}
	dfDescript = data.frame(matrix(ncol = 3, nrow = length(varCat)))
	colnames(dfDescript) = c('n', '%', 'N missing')
	rownames(dfDescript) = varCat
	
	row = 1
	for (i in 1:length(vars)){
		for (j in 1:length(levels(df[[vars[i]]]))){
			dfDescript[row,] = c(table(df[[vars[i]]])[j], round((table(df[[vars[i]]])/nrow(df))[j]*100, 1), sum(is.na(df[[vars[i]]])))
			row = row + 1
		}
	}
	return(dfDescript)
}	

pDatAge3Metal$parity_d = factor(pDatAge3Metal$parity_d)
pDatAge3Metal$education_mom_epi_epia_d = factor(pDatAge3Metal$education_mom_epi_epia_d)
pDatAge3Metal$coll_grad = factor(pDatAge3Metal$coll_grad)
pDatAge3Metal$female_d = factor(pDatAge3Metal$female_d)
pDatAge3Metal$smokpreg_final_d = factor(pDatAge3Metal$smokpreg_final_d)
pDatAge3Metal$SMKEXP_EPQ = factor(pDatAge3Metal$SMKEXP_EPQ)
pDatAge3Metal$smkexp_mpq = factor(pDatAge3Metal$smkexp_mpq)
pDatAge3Metal$csection = factor(pDatAge3Metal$csection)
pDatAge3Metal$race_child_3y_dx = factor(pDatAge3Metal$race_child_3y_dx)
pDatAge3Metal$gt70k = factor(pDatAge3Metal$gt70k)

tab2 = tabFreq(pDatAge3Metal, c('parity_d', 'education_mom_epi_epia_d', 'coll_grad', 'gt70k', 'female_d', 'smokpreg_final_d', 'SMKEXP_EPQ', 'smkexp_mpq', 'csection', 'race_child_3y_dx'))

```

```{r, echo = F}
tab1 %>% kable() %>% kable_styling(font_size = 14) 
```

```{r, echo = F}
tab2 %>% kable() %>% kable_styling(font_size = 14) 
```

### Metals

#### Excluding <LOD 

```{r,warning=FALSE,message=FALSE,eval= FALSE, echo = F}

# function to summarize metal data
tabMetals = function(df, vars){
	dfMetal = data.frame(matrix(ncol = 4, nrow = length(vars)))
	colnames(dfMetal) = c('median', 'IQR', 'n below LOD', 'n missing')
	rownames(dfMetal) = vars
	for (i in 1:length(vars)){
		metal = df[vars[i]][df[,paste0(vars[i], '_comment')] == 0 & !(is.na(df[vars[i]]))]
		dfMetal[i,] = c(round(median(metal), 1), paste0(round(quantile(metal)[2], 1), ', ', round(quantile(metal)[4], 1)), table(df[,paste0(vars[i], '_comment')] == 37)[2], sum(is.na(df[vars[i]])))
	}
	return(dfMetal)
}

dfMetMedian = tabMetals(pDatAge3Metal, c('Al', 'As', 'Ba', 'Cd', 'Co', 'Cr', 'Cs', 'Cu', 'Hg', 'Mg', 'Mn', 'Mo', 'Ni', 'Pb', 'Sb', 'Se', 'Sn', 'Tl', 'V', 'Zn'))
```

```{r, echo = F}
dfMetMedian %>% kable() %>% kable_styling(font_size = 14) 
```


#### Replacing <LOD with LOD/sqrt(2)

```{r,warning=FALSE,message=FALSE,eval= FALSE, echo = F}

pDatAge3Metal$Al_lod = pDatAge3Metal$Al
pDatAge3Metal$Al_lod[pDatAge3Metal$Al_comment == 37] = 13.3/sqrt(2)

pDatAge3Metal$As_lod = pDatAge3Metal$As
pDatAge3Metal$As_lod[pDatAge3Metal$As_comment == 37] = 0.153/sqrt(2)

pDatAge3Metal$Ba_lod = pDatAge3Metal$Ba
pDatAge3Metal$Ba_lod[pDatAge3Metal$Ba_comment == 37] = 0.412/sqrt(2)

pDatAge3Metal$Cd_lod = pDatAge3Metal$Cd
pDatAge3Metal$Cd_lod[pDatAge3Metal$Cd_comment == 37] = 0.0569/sqrt(2)

pDatAge3Metal$Co_lod = pDatAge3Metal$Co
pDatAge3Metal$Co_lod[pDatAge3Metal$Co_comment == 37] = 0.0648/sqrt(2)

pDatAge3Metal$Cr_lod = pDatAge3Metal$Cr
pDatAge3Metal$Cr_lod[pDatAge3Metal$Cr_comment == 37] = 0.685/sqrt(2)

pDatAge3Metal$Cs_lod = pDatAge3Metal$Cs
pDatAge3Metal$Cs_lod[pDatAge3Metal$Cs_comment == 37] = 0.0587/sqrt(2)

pDatAge3Metal$Cu_lod = pDatAge3Metal$Cu
pDatAge3Metal$Cu_lod[pDatAge3Metal$Cu_comment == 37] = 1.85/sqrt(2)

pDatAge3Metal$Hg_lod = pDatAge3Metal$Hg
pDatAge3Metal$Hg_lod[pDatAge3Metal$Hg_comment == 37 & !is.na(pDatAge3Metal$Hg_comment)] = 0.3/sqrt(2)

pDatAge3Metal$Mg_lod = pDatAge3Metal$Mg
pDatAge3Metal$Mg_lod[pDatAge3Metal$Mg_comment == 37] = 4.15/sqrt(2)

pDatAge3Metal$Mn_lod = pDatAge3Metal$Mn
pDatAge3Metal$Mn_lod[pDatAge3Metal$Mn_comment == 37] = 0.422/sqrt(2)

pDatAge3Metal$Mo_lod = pDatAge3Metal$Mo
pDatAge3Metal$Mo_lod[pDatAge3Metal$Mo_comment == 37] = 0.201/sqrt(2)

pDatAge3Metal$Ni_lod = pDatAge3Metal$Ni
pDatAge3Metal$Ni_lod[pDatAge3Metal$Ni_comment == 37] = 0.484/sqrt(2)

pDatAge3Metal$Pb_lod = pDatAge3Metal$Pb
pDatAge3Metal$Pb_lod[pDatAge3Metal$Pb_comment == 37] = 0.0746/sqrt(2)

pDatAge3Metal$Sb_lod = pDatAge3Metal$Sb
pDatAge3Metal$Sb_lod[pDatAge3Metal$Sb_comment == 37] = 0.0937/sqrt(2)

pDatAge3Metal$Se_lod = pDatAge3Metal$Se
pDatAge3Metal$Se_lod[pDatAge3Metal$Se_comment == 37] = 1.73/sqrt(2)

pDatAge3Metal$Sn_lod = pDatAge3Metal$Sn
pDatAge3Metal$Sn_lod[pDatAge3Metal$Sn_comment == 37] = 1.41/sqrt(2)

pDatAge3Metal$Tl_lod = pDatAge3Metal$Tl
pDatAge3Metal$Tl_lod[pDatAge3Metal$Tl_comment == 37] = 0.0937/sqrt(2)

pDatAge3Metal$V_lod = pDatAge3Metal$V
pDatAge3Metal$V_lod[pDatAge3Metal$V_comment == 37] = 0.0475/sqrt(2)

pDatAge3Metal$Zn_lod = pDatAge3Metal$Zn
pDatAge3Metal$Zn_lod[pDatAge3Metal$Zn_comment == 37] = 8.74/sqrt(2)

# function to summarize metals data
tabMetals_lod = function(df, vars){
	dfMetal = data.frame(matrix(ncol = 2, nrow = length(vars)))
	colnames(dfMetal) = c('median', 'IQR')
	rownames(dfMetal) = vars
	for (i in 1:length(vars)){
		metal = df[[vars[i]]][!(is.na(df[[vars[i]]]))]
		dfMetal[i,] = c(round(median(metal), 1), paste0(round(quantile(metal)[2], 1), ', ', round(quantile(metal)[4], 1)))
	}
	return(dfMetal)
}

dfMetMedian_lod = tabMetals_lod(pDatAge3Metal, c('Al_lod', 'As_lod', 'Ba_lod', 'Cd_lod', 'Co_lod', 'Cr_lod', 'Cs_lod', 'Cu_lod', 'Mg_lod', 'Mn_lod', 'Mo_lod', 'Ni_lod', 'Pb_lod', 'Sb_lod', 'Se_lod', 'Sn_lod', 'Tl_lod', 'V_lod', 'Zn_lod'))
```

```{r, echo = F}
dfMetMedian %>% kable() %>% kable_styling(font_size = 14) 
```


## Correlation between metals (insignificant correlations are not shaded)

```{r, warning=FALSE,message=FALSE,eval=FALSE, echo = F}
M = cor(pDatAge3Metal[,c('As', 'Ba', 'Cd', 'Cr', 'Cs', 'Cu', 'Hg', 'Mg', 'Mn', 'Pb', 'Se', 'Zn')], method = 'spearman', use='complete')
res1 = cor.mtest(pDatAge3Metal[,c('As', 'Ba', 'Cd', 'Cr', 'Cs', 'Cu', 'Hg', 'Mg', 'Mn', 'Pb', 'Se', 'Zn')], conf.level = .95, method = 'spearman', exact = F, use='complete')
```

```{r, warning=FALSE,message=FALSE,eval = F}
corrplot(M, method = "color", 
         type = "upper", number.cex = .7,
         addCoef.col = "black", # Add coefficient of correlation
         tl.col = "black", tl.srt = 90, # Text label color and rotation
         # Combine with significance
         p.mat = res1$p, sig.level = 0.05, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag = FALSE)
         
quartz.save('/Users/annebozack/Documents/Cardenas/viva_DNAm_metals_local/metalCorr_age3.png', type = "png", dpi = 300)
```

```{r, out.width = '75%'}
knitr::include_graphics("/Users/annebozack/Documents/Cardenas/viva_DNAm_metals_local/metalCorr_age3.png")
```


## Clean covariate data and log2 transformations

```{r, warning=FALSE,message=FALSE,eval=FALSE}

pDatAge3Metal$race_child2[pDatAge3Metal$race_child_3y_dx == 'white'] = 1  # white = reference
pDatAge3Metal$race_child2[pDatAge3Metal$race_child_3y_dx == 'black'] = 2 # black
pDatAge3Metal$race_child2[pDatAge3Metal$race_child_3y_dx == 'hispa'] = 3 # hispanic
pDatAge3Metal$race_child2[pDatAge3Metal$race_child_3y_dx == 'asian'] = 4 # asian
pDatAge3Metal$race_child2[pDatAge3Metal$race_child_3y_dx == 'more than 1 race' | pDatAge3Metal$race_child_3y_dx == 'other'] = 5 # more than 1 race or other
pDatAge3Metal$race_child2 = factor(pDatAge3Metal$race_child2)

pDatAge3Metal$smk_preg[pDatAge3Metal$smokpreg_final_d == 'smoke preg'] = 1
pDatAge3Metal$smk_preg[pDatAge3Metal$smokpreg_final_d == 'xnever' | pDatAge3Metal$smokpreg_final_d == 'former'] = 0
pDatAge3Metal$smk_preg = factor(pDatAge3Metal$smk_preg)

# log2 transformation
pDatAge3Metal$Al_log2 = log(pDatAge3Metal$Al_lod, 2)
pDatAge3Metal$As_log2 = log(pDatAge3Metal$As_lod, 2)
pDatAge3Metal$Ba_log2 = log(pDatAge3Metal$Ba_lod, 2)
pDatAge3Metal$Cd_log2 = log(pDatAge3Metal$Cd_lod, 2)
pDatAge3Metal$Co_log2 = log(pDatAge3Metal$Co_lod, 2)
pDatAge3Metal$Cr_log2 = log(pDatAge3Metal$Cr_lod, 2)
pDatAge3Metal$Cs_log2 = log(pDatAge3Metal$Cs_lod, 2)
pDatAge3Metal$Cu_log2 = log(pDatAge3Metal$Cu_lod, 2)
pDatAge3Metal$Mg_log2 = log(pDatAge3Metal$Mg_lod, 2)
pDatAge3Metal$Hg_log2 = log(pDatAge3Metal$Hg_lod, 2)
pDatAge3Metal$Mn_log2 = log(pDatAge3Metal$Mn_lod, 2)
pDatAge3Metal$Mo_log2 = log(pDatAge3Metal$Mo_lod, 2)
pDatAge3Metal$Ni_log2 = log(pDatAge3Metal$Ni_lod, 2)
pDatAge3Metal$Pb_log2 = log(pDatAge3Metal$Pb_lod, 2)
pDatAge3Metal$Sb_log2 = log(pDatAge3Metal$Sb_lod, 2)
pDatAge3Metal$Se_log2 = log(pDatAge3Metal$Se_lod, 2)
pDatAge3Metal$Sn_log2 = log(pDatAge3Metal$Sn_lod, 2)
pDatAge3Metal$Tl_log2 = log(pDatAge3Metal$Tl_lod, 2)
pDatAge3Metal$V_log2 = log(pDatAge3Metal$V_lod, 2)
pDatAge3Metal$Zn_log2 = log(pDatAge3Metal$Zn_lod, 2)

# Indicator variable for above LOD
pDatAge3Metal$Al_det[pDatAge3Metal$Al_comment == 37] = 1
pDatAge3Metal$Al_det[pDatAge3Metal$Al_comment == 0] = 0
pDatAge3Metal$As_det[pDatAge3Metal$As_comment == 37] = 1
pDatAge3Metal$As_det[pDatAge3Metal$As_comment == 0] = 0
pDatAge3Metal$Ba_det[pDatAge3Metal$Ba_comment == 37] = 1
pDatAge3Metal$Ba_det[pDatAge3Metal$Ba_comment == 0] = 0
pDatAge3Metal$Cd_det[pDatAge3Metal$Cd_comment == 37] = 1
pDatAge3Metal$Cd_det[pDatAge3Metal$Cd_comment == 0] = 0
pDatAge3Metal$Co_det[pDatAge3Metal$Co_comment == 37] = 1
pDatAge3Metal$Co_det[pDatAge3Metal$Co_comment == 0] = 0
pDatAge3Metal$Cr_det[pDatAge3Metal$Cr_comment == 37] = 1
pDatAge3Metal$Cr_det[pDatAge3Metal$Cr_comment == 0] = 0
pDatAge3Metal$Hg_det[pDatAge3Metal$Hg_comment == 37 & !is.na(pDatAge3Metal$Hg_comment)] = 1
pDatAge3Metal$Hg_det[pDatAge3Metal$Hg_comment == 0 & !is.na(pDatAge3Metal$Hg_comment)] = 0
pDatAge3Metal$Mn_det[pDatAge3Metal$Mn_comment == 37] = 1
pDatAge3Metal$Mn_det[pDatAge3Metal$Mn_comment == 0] = 0
pDatAge3Metal$Mo_det[pDatAge3Metal$Mo_comment == 37] = 1
pDatAge3Metal$Mo_det[pDatAge3Metal$Mo_comment == 0] = 0
pDatAge3Metal$Ni_det[pDatAge3Metal$Ni_comment == 37] = 1
pDatAge3Metal$Ni_det[pDatAge3Metal$Ni_comment == 0] = 0
pDatAge3Metal$Sb_det[pDatAge3Metal$Sb_comment == 37] = 1
pDatAge3Metal$Sb_det[pDatAge3Metal$Sb_comment == 0] = 0
pDatAge3Metal$Sn_det[pDatAge3Metal$Sn_comment == 37] = 1
pDatAge3Metal$Sn_det[pDatAge3Metal$Sn_comment == 0] = 0
pDatAge3Metal$V_det[pDatAge3Metal$V_comment == 37] = 1
pDatAge3Metal$V_det[pDatAge3Metal$V_comment == 0] = 0

```

## Associations with cell type %

```{r, warning=FALSE,message=FALSE,eval=FALSE}

# function for generating table with lm results
cellAssoc = function(data, cells, metals){
	results = data.frame(matrix(nrow = length(metals), ncol = length(cells)*2))
	rownames(results) = metals
	colnames(results) = unlist(lapply(1:length(cells), function(x) c(paste0(cells[x], '_B'), paste0(cells[x], '_p'))))
	for (i in 1:length(metals)){
		metals_comment = paste0(metals, '_comment')
		metals_log2 = paste0(metals, '_log2')
		# testing associations for metals detected in >= 80% of samples
		for (j in 1:length(cells)){
			col = j + (j-1)
			mod = lm((data[[cells[j]]] * 100) ~ data[[metals_log2[i]]] + data$female_d + data$race_child2 + data$gestage_wks_deliv_d + data$age_mom_enroll_d + data$bmi_mom_prepreg_d + data$coll_grad + data$nullip + data$gt70k + data$smk_preg)
			results[i,col] = summary(mod)$coefficients[2,1]
			results[i,col+1] = summary(mod)$coefficients[2,4]
		}
	}
	return(results)
}

# metals detected in > 80% of samples
metals = c('As', 'Ba', 'Cd', 'Cr', 'Cs', 'Cu', 'Hg', 'Mg', 'Mn', 'Pb', 'Se', 'Zn')

# cord blood cell types
cells = c('Bcell_S_3y', 'CD4T_S_3y', 'CD8T_S_3y', 'Neu_S_3y', 'Mono_S_3y', 'NK_S_3y')

cellAssocTab = cellAssoc(pDatAge3Metal, cells, metals)

cellAssocTab = round(cellAssocTab, 3)

colnames(cellAssocTab) = rep(c('B', 'p'), times = 6)

```

```{r,warning=FALSE,message=FALSE,echo = F}
kbl(cellAssocTab) %>% kable_paper() %>% add_header_above(c(" ", "B cell 1" = 2, "CD4T" = 2, "CD8T" = 2, "Neu" = 2, "Mono" = 2, "NK" = 2))
```

## Save cleaned datasets

```{r, warning=FALSE,message=FALSE,eval=FALSE}
save(ComBat.Mvalues.Metals, ComBat.Betas.Metals, pDatAge3Metal, file = "/Users/annebozack/Box/NIEHS-R01 ONES/Methylation Data/Age3Blood_ComBat_Betas_Mvlas_filteredPorbes_metalAnalaysis.RData")

```









